{% extends 'main/base.html' %}

{% block title %}Profile - DigiMat{% endblock %}
{% block page_title %}Profile{% endblock %}

{% block content %}
<div class="card" style="width:100%">
    {% if profile %}
        <div class="profile-main-card" style="width:100%">
            <section style="padding-bottom:1rem; border-bottom:1px solid #eee; margin-bottom:1rem">
                <h4>Basic Details</h4>
                <p style="font-size:14px;"><strong>Name</strong> <span class="value">: {{ profile.user.first_name }} {{ profile.user.last_name }}</span></p>
                <p style="font-size:14px;"><strong>Mobile</strong> <span class="value">: {{ profile.mobile }}</span></p>
                <p style="font-size:14px;"><strong>Gender</strong> <span class="value">: {{ profile.get_gender_display }}</span></p>
            </section>

            <section style="padding-bottom:1rem; border-bottom:1px solid #eee; margin-bottom:1rem">
                <h4>Birth Details</h4>
                {% if profile.birth_detail %}
                    <p style="font-size:14px;"><strong>Date</strong> <span class="value">: {{ profile.birth_detail.date_of_birth }}</span></p>
                    <p style="font-size:14px;"><strong>Place</strong> <span class="value">: {{ profile.birth_detail.place_of_birth }}</span></p>
                    <p style="font-size:14px;"><strong>Rasi</strong> <span class="value">: {{ profile.birth_detail.rasi }}</span></p>
                    <p style="font-size:14px;"><strong>Star</strong> <span class="value">: {{ profile.birth_detail.star }}</span></p>
                    <p style="font-size:14px;"><strong>Dhosam</strong> <span class="value">: {{ profile.birth_detail.dhosam }}</span></p>
                {% else %}
                    <p><em>Birth details not added yet</em></p>
                {% endif %}
            </section>
            
            <section style="padding-bottom:1rem; border-bottom:1px solid #eee; margin-bottom:1rem">
                <h4>Family Details</h4>
                {% if profile.family_detail %}
                    <p style="font-size:14px;"><strong>Father</strong> <span class="value">: {{ profile.family_detail.father_name }}</span></p>
                    <p style="font-size:14px;"><strong>Mother</strong> <span class="value">: {{ profile.family_detail.mother_name }}</span></p>
                    <p style="font-size:14px;"><strong>Siblings</strong> <span class="value">: {{ profile.family_detail.siblings }}</span></p>
                    <p style="font-size:14px;"><strong>Caste</strong> <span class="value">: {{ profile.family_detail.caste }}</span></p>
                {% else %}
                    <p><em>Family details not added yet</em></p>
                {% endif %}
            </section>
        
            <section>
                <h4>Professional Details</h4>
                {% if profile.professional_detail %}
                    <p style="font-size:14px;"><strong>Education</strong> <span class="value">: {{ profile.professional_detail.education }}</span></p>
                    <p style="font-size:14px;"><strong>Profession</strong> <span class="value">: {{ profile.professional_detail.profession }}</span></p>
                    <p style="font-size:14px;"><strong>Income</strong> <span class="value">: {{ profile.professional_detail.monthly_income }}</span></p>
                {% else %}
                    <p><em>Professional details not added yet</em></p>
                {% endif %}
            </section>

            <!-- Profile Photos (read-only grid) -->
            <section style="margin-bottom:2rem;">
                <h4>Profile Photos</h4>
                {% with photos=profile.photos.all %}
                {% if photos %}
                <style>
                .photo-stack { position:relative;width:100%;max-width:600px;height:220px;margin:auto; }
                .card-photo { position:absolute;width:100%;height:220px;border-radius:12px;box-shadow:0 2px 8px #bbb;background:#fff;cursor:pointer;transition:box-shadow 0.2s; }
                .card-photo.primary { border:3px solid #128c7e;box-shadow:0 4px 16px #888;z-index:10; }
                .card-photo:not(.primary) { border:2px solid #ccc;z-index:1; }
                </style>
                <div class="photo-stack">
                    {% for p in photos|dictsortreversed:"is_primary" %}
                        {% if p.is_primary %}
                            <div class="card-photo primary" style="top:0;left:0;" onclick="openPhotoViewer({{ forloop.counter0 }})">
                                <img src="{{ p.image.url }}" alt="Primary photo" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">
                                <div class="badge" style="position:absolute;top:8px;left:8px;background:#128c7e;color:#fff;padding:2px 8px;border-radius:4px;font-size:12px;">Primary</div>
                            </div>
                        {% else %}
                            <div class="card-photo" style="top:{{ forloop.counter0|add:'16' }}px;left:{{ forloop.counter0|add:'8' }}px;" onclick="openPhotoViewer({{ forloop.counter0 }})">
                                <img src="{{ p.image.url }}" alt="photo" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                <!-- Photo Viewer Modal -->
                <div id="photoViewerModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center;">
                    <span onclick="closePhotoViewer()" style="position:absolute;top:30px;right:40px;font-size:32px;color:#fff;cursor:pointer;">&times;</span>
                    <button id="photoPrevBtn" onclick="photoPrev()" style="position:absolute;left:40px;top:50%;transform:translateY(-50%);font-size:32px;color:#fff;background:none;border:none;cursor:pointer;">&#8592;</button>
                    <img id="photoViewerImg" src="" alt="Photo" style="max-width:80vw;max-height:80vh;border-radius:12px;box-shadow:0 0 24px #222;display:block;margin:auto;">
                    <button id="photoNextBtn" onclick="photoNext()" style="position:absolute;right:40px;top:50%;transform:translateY(-50%);font-size:32px;color:#fff;background:none;border:none;cursor:pointer;">&#8594;</button>
                </div>
                {% else %}
                    <div style="color:#888;text-align:center;padding:2rem 0;">No photos uploaded yet.</div>
                {% endif %}
                {% endwith %}
                <script>
                var photoUrls = [
                    {% for p in profile.photos.all %}'{{ p.image.url|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}
                ];
                var currentPhotoIdx = 0;
                function openPhotoViewer(idx) {
                    currentPhotoIdx = idx;
                    document.getElementById('photoViewerImg').src = photoUrls[idx];
                    document.getElementById('photoViewerModal').style.display = 'flex';
                    updatePhotoNav();
                }
                function closePhotoViewer() {
                    document.getElementById('photoViewerModal').style.display = 'none';
                }
                function photoPrev() {
                    if(currentPhotoIdx > 0) {
                        currentPhotoIdx--;
                        document.getElementById('photoViewerImg').src = photoUrls[currentPhotoIdx];
                        updatePhotoNav();
                    }
                }
                function photoNext() {
                    if(currentPhotoIdx < photoUrls.length-1) {
                        currentPhotoIdx++;
                        document.getElementById('photoViewerImg').src = photoUrls[currentPhotoIdx];
                        updatePhotoNav();
                    }
                }
                function updatePhotoNav() {
                    document.getElementById('photoPrevBtn').style.display = (currentPhotoIdx === 0) ? 'none' : 'block';
                    document.getElementById('photoNextBtn').style.display = (currentPhotoIdx === photoUrls.length-1) ? 'none' : 'block';
                }
                document.addEventListener('keydown', function(e){
                    if(e.key === 'Escape') closePhotoViewer();
                });
                </script>
            </section>
        </div>
        <p style="margin-top:1rem;font-size:14px;"><a href="{% url 'matches' %}">Back to Matches</a></p>
    {% else %}
        <p>No profile found.</p>
    {% endif %}
</div>
{% endblock %}
